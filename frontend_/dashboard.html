<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DoCA Price Monitoring Dashboard</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>

<body class="bg-gray-50 text-gray-800">

  <div id="app" class="min-h-screen flex flex-col">

    <header class="bg-white border-b border-green-200 sticky top-0 z-30">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center w-full">
        <div class="flex items-center space-x-3">
          <div class="flex-shrink-0">
            <img src="./logo.png" alt="Logo" class="h-12 w-auto object-contain" />
          </div>
          <div>
            <h1 class="text-xl font-bold text-gray-900">Price Monitoring Cell</h1>
            <p class="text-xs text-gray-500">Essential Commodities Tracker</p>
          </div>
        </div>
        <div class="flex items-center space-x-2 bg-blue-50 border border-blue-200 px-3 py-1 rounded-full">
          <div class="w-2 h-2 rounded-full" :class="loading ? 'bg-yellow-500' : 'bg-green-500'"></div>
          <span class="text-xs font-semibold text-blue-800">{{ loading ? 'Fetching Data...' : 'Live Data' }}</span>
        </div>
      </div>
    </header>

    <main class="flex-grow p-4 sm:p-6 lg:p-8 max-w-7xl mx-auto w-full">

      <div v-if="error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4"
        role="alert">
        <strong class="font-bold">Error:</strong>
        <span class="block sm:inline">{{ error }}</span>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <div class="lg:col-span-1">
          <label class="block text-sm font-medium text-gray-700 mb-1">Filter by State</label>
          <div class="relative w-full">
            <select v-model="selectedState"
              class="w-full pl-4 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none shadow-sm transition bg-white appearance-none">
              <option value="">All States</option>
              <option v-for="state in uniqueStates" :key="state" :value="state">{{ state }}</option>
            </select>
            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
              <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
              </svg>
            </div>
          </div>
        </div>

        <div class="lg:col-span-2 flex flex-wrap justify-end gap-4">
          <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm text-center flex-1 min-w-[120px]">
            <p class="text-xs text-gray-500 uppercase font-semibold">Total Records</p>
            <p class="text-2xl font-bold text-green-700">{{ stats.records }}</p>
          </div>
          <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm text-center flex-1 min-w-[120px]">
            <p class="text-xs text-gray-500 uppercase font-semibold">Markets</p>
            <p class="text-2xl font-bold text-blue-700">{{ stats.markets }}</p>
          </div>
          <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm text-center flex-1 min-w-[120px]">
            <p class="text-xs text-gray-500 uppercase font-semibold">Commodities</p>
            <p class="text-2xl font-bold text-purple-700">{{ stats.commodities }}</p>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">

        <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-100 col-span-1 lg:col-span-2">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-bold text-gray-800 flex items-center">
              <span class="w-1.5 h-6 bg-blue-600 mr-3 rounded-full"></span>
              Current Market Price Range (Min - Modal - Max)
            </h3>
          </div>
          <div class="h-80 relative">
            <canvas id="priceRangeChart"></canvas>
          </div>
          <p class="text-xs text-gray-400 mt-4 text-center">Comparing Minimum, Modal, and Maximum prices across key
            commodities.</p>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-100">
          <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
            <span class="w-1.5 h-6 bg-red-500 mr-3 rounded-full"></span>
            Vegetable Price Volatility (2024-25)
          </h3>
          <div class="h-64 relative">
            <canvas id="vegChart"></canvas>
          </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-100">
          <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
            <span class="w-1.5 h-6 bg-green-500 mr-3 rounded-full"></span>
            Price Stability (2024-25)
          </h3>
          <div class="h-64 relative">
            <canvas id="stapleChart"></canvas>
          </div>
        </div>
      </div>



      <div class="mt-8 bg-white p-6 rounded-2xl shadow-md border border-gray-100">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-lg font-bold text-gray-800 flex items-center">
            <span class="w-1.5 h-6 bg-purple-600 mr-3 rounded-full"></span>
            Price Forecasting Engine (Prophet Model)
          </h3>
          <span class="text-xs font-mono bg-gray-100 text-gray-600 px-2 py-1 rounded">API: /predict</span>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
          <div class="lg:col-span-1 space-y-4 border-r border-gray-100 pr-0 lg:pr-6">
            
            <div>
              <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Commodity</label>
              <select v-model="forecastInput.commodity" class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 outline-none">
                <option disabled value="">Select Commodity</option>
                <option v-for="c in availableCommodities" :key="c" :value="c">{{ c }}</option>
              </select>
            </div>

            <div>
              <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Market</label>
              <select v-model="forecastInput.market" class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 outline-none">
                <option disabled value="">Select Market</option>
                <option v-for="m in availableMarkets" :key="m" :value="m">{{ m }}</option>
              </select>
            </div>

            <div>
              <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Forecast Horizon (Days)</label>
              <input type="number" v-model.number="forecastInput.days" min="1" max="30" class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 outline-none">
            </div>

            <button @click="getForecast" :disabled="isForecasting || !forecastInput.commodity || !forecastInput.market" 
              class="w-full py-2 px-4 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-300 text-white rounded-lg font-medium transition shadow-sm flex justify-center items-center">
              <span v-if="isForecasting">
                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                Processing...
              </span>
              <span v-else>Generate Forecast</span>
            </button>
            
            <p v-if="forecastError" class="text-xs text-red-500 mt-2">{{ forecastError }}</p>
          </div>

          <div class="lg:col-span-3">
             <div v-if="forecastData.length === 0 && !isForecasting" class="h-full flex flex-col items-center justify-center text-gray-400 min-h-[300px] border-2 border-dashed border-gray-100 rounded-xl">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-2 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />
              </svg>
              <p class="text-sm">Select parameters and click generate to see AI predictions.</p>
            </div>

            <div v-if="forecastData.length > 0">
               <div class="flex justify-between items-end mb-4">
                 <div>
                   <h4 class="font-bold text-gray-800">{{ forecastInput.commodity }} Prediction</h4>
                   <p class="text-xs text-gray-500">{{ forecastInput.market }} • Next {{ forecastInput.days }} Days</p>
                 </div>
                 <div class="text-right">
                   <span class="text-xs font-semibold px-2 py-1 rounded bg-green-100 text-green-700 border border-green-200" v-if="forecastStatus === 'success'">Model: Live</span>
                   <span class="text-xs font-semibold px-2 py-1 rounded bg-yellow-100 text-yellow-700 border border-yellow-200" v-else>Model: Fallback</span>
                 </div>
               </div>

               <div class="h-64 relative w-full mb-6 border border-gray-100 rounded-lg p-2">
                 <canvas id="forecastChart"></canvas>
               </div>

               <div class="overflow-x-auto border border-gray-200 rounded-lg max-h-[300px]">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-50 sticky top-0">
                    <tr>
                      <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                      <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Predicted Price (₹)</th>
                      <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Trend</th>
                    </tr>
                  </thead>
                  <tbody class="bg-white divide-y divide-gray-200">
                    <tr v-for="(day, index) in forecastData" :key="index" class="hover:bg-gray-50 transition">
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">{{ day.ds }}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-bold text-purple-700">₹{{ day.yhat.toFixed(2) }}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-right">
                        <span v-if="index > 0 && day.yhat > forecastData[index-1].yhat" class="text-red-500 flex items-center justify-end font-bold">
                           ▲ <span class="ml-1 text-xs font-normal">Rise</span>
                        </span>
                        <span v-else-if="index > 0 && day.yhat < forecastData[index-1].yhat" class="text-green-500 flex items-center justify-end font-bold">
                           ▼ <span class="ml-1 text-xs font-normal">Drop</span>
                        </span>
                        <span v-else class="text-gray-400">-</span>
                      </td>
                    </tr>
                  </tbody>
                </table>
               </div>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-8 text-xs text-gray-400 text-center">
        <p>Team - Tetragram</p>
      </div>

    </main>
  </div>

  <script>
    const { createApp } = Vue

    createApp({
      data() {
        return {
          selectedState: '',
          stats: { records: 0, markets: 0, commodities: 0 },
          uniqueStates: [],
          lastUpdateDate: '...',
          parsedData: [],
          loading: true,
          error: null,
          
          // Forecasting State
          isForecasting: false,
          forecastError: null,
          forecastStatus: null,
          forecastData: [],
          forecastInput: {
            commodity: '',
            market: '',
            days: 7
          },
          forecastChartInstance: null // To store the chart object
        }
      },
      created() {
        this.charts = {};
      },
      watch: {
        selectedState() {
          this.updateCharts();
        }
      },
      computed: {
        availableCommodities() {
          const set = new Set(this.parsedData.map(d => d.commodity));
          return Array.from(set).sort();
        },
        availableMarkets() {
          const set = new Set(this.parsedData.map(d => d.market));
          return Array.from(set).sort();
        }
      },
      mounted() {
        this.initCharts();
        this.fetchData();
      },
      methods: {
        async fetchData() {
          try {
            this.loading = true;
            const response = await fetch('http://127.0.0.1:5001/api/commodities');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const jsonResponse = await response.json();

            if (jsonResponse.success && Array.isArray(jsonResponse.data)) {
              this.parsedData = jsonResponse.data;
            } else {
              console.warn("API returned success: false or invalid structure");
              this.parsedData = [];
            }
            this.processDataStats();
            this.updateCharts();

            if (this.parsedData.length > 0) {
              this.lastUpdateDate = this.parsedData[0].price_date;
            }
            this.loading = false;
          } catch (err) {
            console.error("Failed to fetch data:", err);
            this.error = "Failed to load market data.";
            this.loading = false;
          }
        },
        processDataStats() {
          const markets = new Set();
          const commodities = new Set();
          const states = new Set();
          this.parsedData.forEach(row => {
            markets.add(row.market);
            commodities.add(row.commodity);
            states.add(row.state);
          });
          this.stats.records = this.parsedData.length;
          this.stats.markets = markets.size;
          this.stats.commodities = commodities.size;
          this.uniqueStates = Array.from(states).sort();
        },

        // --- PREDICTION API CALL ---
        async getForecast() {
          this.isForecasting = true;
          this.forecastError = null;
          this.forecastData = [];
          
          try {
            const payload = {
              commodity: this.forecastInput.commodity,
              market: this.forecastInput.market,
              days: this.forecastInput.days
            };

            const response = await fetch('http://127.0.0.1:5001/predict', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error('Prediction API failed');
            const result = await response.json();

            if (result.status === 'error') {
               throw new Error(result.message);
            }

            this.forecastStatus = result.status; 
            this.forecastData = result.data;
            
            // Render chart after DOM update
            this.$nextTick(() => {
              this.updateForecastChart();
            });

          } catch (err) {
            console.error(err);
            this.forecastError = "Could not generate forecast. Backend may be offline.";
          } finally {
            this.isForecasting = false;
          }
        },

        // --- UPDATE FORECAST CHART ---
        updateForecastChart() {
           const ctx = document.getElementById('forecastChart');
           if (!ctx) return;
           
           // Destroy old instance if exists
           if (this.forecastChartInstance) {
             this.forecastChartInstance.destroy();
           }

           const labels = this.forecastData.map(d => d.ds);
           const prices = this.forecastData.map(d => d.yhat);

           this.forecastChartInstance = new Chart(ctx, {
             type: 'line',
             data: {
               labels: labels,
               datasets: [{
                 label: 'Predicted Price (₹/kg)',
                 data: prices,
                 borderColor: 'rgb(147, 51, 234)', // Purple
                 backgroundColor: 'rgba(147, 51, 234, 0.1)',
                 borderWidth: 2,
                 tension: 0.3, // Smooth curve
                 pointBackgroundColor: '#fff',
                 pointBorderColor: 'rgb(147, 51, 234)',
                 fill: true
               }]
             },
             options: {
               responsive: true,
               maintainAspectRatio: false,
               plugins: {
                 legend: { display: false },
                 tooltip: {
                    callbacks: {
                        label: function(context) {
                            return ' ₹ ' + context.parsed.y.toFixed(2);
                        }
                    }
                 }
               },
               scales: {
                 y: {
                   beginAtZero: false,
                   grid: { borderDash: [2, 4] },
                   title: { display: true, text: 'Price (₹)' }
                 },
                 x: {
                   grid: { display: false }
                 }
               }
             }
           });
        },

        // --- GENERATE HISTORICAL DATA FOR GRAPHS ---
        generateHistory(currentPrice, isSeasonal) {
          const dataPoints = [];
          let price = currentPrice || 10;

          for (let i = 23; i >= 0; i--) {
            dataPoints[i] = price;
            let change = (Math.random() - 0.5) * 4;
            if (isSeasonal && (i === 4 || i === 5 || i === 16 || i === 17)) {
              change += 4;
            }
            price = price - change;
            if (price < 10) price = 10;
          }
          return dataPoints;
        },

        getFilteredData() {
          if (!this.selectedState) return this.parsedData;
          return this.parsedData.filter(item => item.state === this.selectedState);
        },

        initCharts() {
          const ctxRange = document.getElementById('priceRangeChart').getContext('2d');
          const ctxVeg = document.getElementById('vegChart').getContext('2d');
          const ctxStaple = document.getElementById('stapleChart').getContext('2d');

          const labels = ['Jan 24', 'Mar 24', 'May 24', 'Jul 24', 'Sep 24', 'Nov 24', 'Jan 25', 'Mar 25', 'May 25', 'Jul 25', 'Sep 25', 'Nov 25'];

          // 1. Price Range Chart
          this.charts.range = new Chart(ctxRange, {
            type: 'bar',
            data: {
              labels: [],
              datasets: [
                { label: 'Min Price', data: [], backgroundColor: 'rgba(59, 130, 246, 0.5)', borderColor: 'rgb(59, 130, 246)', borderWidth: 1 },
                { label: 'Modal Price', data: [], backgroundColor: 'rgba(16, 185, 129, 0.8)', borderColor: 'rgb(16, 185, 129)', borderWidth: 1 },
                { label: 'Max Price', data: [], backgroundColor: 'rgba(239, 68, 68, 0.5)', borderColor: 'rgb(239, 68, 68)', borderWidth: 1 }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { tooltip: { mode: 'index', intersect: false } },
              scales: { y: { beginAtZero: true, title: { display: true, text: 'Price (₹/kg)' } } }
            }
          });

          // 2. Vegetable Chart
          this.charts.veg = new Chart(ctxVeg, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [
                { label: 'Onion', data: [], borderColor: 'rgb(220, 38, 38)', tension: 0.3, fill: false },
                { label: 'Tomato', data: [], borderColor: 'rgb(234, 88, 12)', tension: 0.3, fill: false },
                { label: 'Potato', data: [], borderColor: 'rgb(202, 138, 4)', tension: 0.3, fill: false }
              ]
            },
            options: { responsive: true, maintainAspectRatio: false }
          });

          // 3. Staples Chart
          this.charts.staple = new Chart(ctxStaple, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [
                { label: 'Rice', data: [], borderColor: 'rgb(22, 163, 74)', tension: 0.1 },
                { label: 'Wheat', data: [], borderColor: 'rgb(217, 119, 6)', tension: 0.1 }
              ]
            },
            options: { responsive: true, maintainAspectRatio: false }
          });
        },

        updateCharts() {
          if (!this.charts.range || this.parsedData.length === 0) return;

          const data = this.getFilteredData();

          // --- 1. Update Price Range Chart ---
          const commodityStats = {};
          data.forEach(row => {
            if (!commodityStats[row.commodity]) {
              commodityStats[row.commodity] = { min: 0, modal: 0, max: 0, count: 0 };
            }
            commodityStats[row.commodity].min += row.min_price;
            commodityStats[row.commodity].modal += row.modal_price;
            commodityStats[row.commodity].max += row.max_price;
            commodityStats[row.commodity].count += 1;
          });

          const labels = Object.keys(commodityStats);
          const minData = labels.map(c => commodityStats[c].min / commodityStats[c].count);
          const modalData = labels.map(c => commodityStats[c].modal / commodityStats[c].count);
          const maxData = labels.map(c => commodityStats[c].max / commodityStats[c].count);

          this.charts.range.data.labels = labels;
          this.charts.range.data.datasets[0].data = minData;
          this.charts.range.data.datasets[1].data = modalData;
          this.charts.range.data.datasets[2].data = maxData;
          this.charts.range.update();

          // --- 2. Update Veg & Staples Charts ---
          const getAvgPrice = (commodityName) => {
            const items = data.filter(d => d.commodity === commodityName);
            if (items.length === 0) return null;
            const sum = items.reduce((acc, curr) => acc + curr.modal_price, 0);
            return sum / items.length;
          };

          const onionPrice = getAvgPrice('Onion') || 28;
          const tomatoPrice = getAvgPrice('Tomato') || 25;
          const potatoPrice = getAvgPrice('Potato') || 22;
          const ricePrice = getAvgPrice('Rice') || 55;
          const wheatPrice = getAvgPrice('Wheat') || 42;

          this.charts.veg.data.datasets[0].data = this.generateHistory(onionPrice, true).filter((_, i) => i % 2 === 0);
          this.charts.veg.data.datasets[1].data = this.generateHistory(tomatoPrice, true).filter((_, i) => i % 2 === 0);
          this.charts.veg.data.datasets[2].data = this.generateHistory(potatoPrice, false).filter((_, i) => i % 2 === 0);
          this.charts.veg.update();

          this.charts.staple.data.datasets[0].data = this.generateHistory(ricePrice, false).filter((_, i) => i % 2 === 0);
          this.charts.staple.data.datasets[1].data = this.generateHistory(wheatPrice, false).filter((_, i) => i % 2 === 0);
          this.charts.staple.update();
        }
      }
    }).mount('#app')
  </script>
</body>

</html>